<!DOCTYPE html>
<html>
    <head>
        <head>
            <!-- Load the core jsPsych library -->
            <script src="jspsych/dist/jspsych.js"></script>
          
            <!-- Load WebGazer core and jsPsych extension (must come before WebGazer plugins) -->
            <script src="jspsych/webgazer.js"></script>
            <script src="jspsych/dist/extension-webgazer.js"></script>
          
            <!-- Load WebGazer-related jsPsych plugins (for camera, calibration, and validation) -->
            <script src="jspsych/dist/plugin-webgazer-init-camera.js"></script>
            <script src="jspsych/dist/plugin-webgazer-calibrate.js"></script>
            <script src="jspsych/dist/plugin-webgazer-validate.js"></script>
          
            <!-- Load only the jsPsych plugins actually used in the experiment -->
            <script src="jspsych/dist/plugin-preload.js"></script>                    <!-- For preloading images -->
            <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>    <!-- For displaying text + listening to keypress -->
            <script src="jspsych/dist/plugin-html-button-response.js"></script>      <!-- For consent forms and instructions with buttons -->
            <script src="jspsych/dist/plugin-survey-html-form.js"></script>          <!-- For collecting participant info -->
            <script src="jspsych/dist/plugin-virtual-chinrest.js"></script>          <!-- For screen distance calibration -->
            <script src="jspsych/dist/plugin-fullscreen.js"></script>                <!-- For full screen mode -->
            <script src="jspsych/dist/plugin-instructions.js"></script>              <!-- For multi-page instructions -->
            <script src="jspsych/dist/plugin-image-keyboard-response.js"></script>   <!-- For showing images and collecting keypresses -->
            <script src="jspsych/dist/plugin-call-function.js"></script>             <!-- For running JavaScript code inside the timeline -->
            <script src="jspsych/dist/plugin-survey-multi-choice.js"></script>       <!-- For multiple-choice survey questions -->

          
            <!-- Load JATOS for server-side integration -->
            <script src="jatos.js"></script>
          </head>
          

          <style>
            /* 1. Full-screen layout with no scrollbars */
            html, body {
              margin: 0;
              padding: 0;
              height: 100%;
              width: 100%;
              font-family: Arial, sans-serif;
              overflow: hidden;
            }
          
            /* 2. Center jsPsych content both vertically and horizontally */
            .jspsych-display-element {
              display: flex !important;
              justify-content: center;
              align-items: center;
              height: 100vh;
              flex-direction: column;
              text-align: center;
            }
          
            /* 3. Prevent jsPsych from shrinking content on large screens */
            .jspsych-content {
              max-width: 100% !important;
              text-align: center;
            }
          
            /* 4. Clean and consistent form input styling */
            input[type="text"],
            input[type="number"],
            select {
              border: 1px solid #ccc;
              padding: 6px 8px;
              font-size: 16px;
              border-radius: 4px;
              box-sizing: border-box;
              background-color: white;
              width: 250px;
              text-align: center;
            }
          
            /* 5. Clean spacing between survey form questions */
            .jspsych-survey-html-form p {
              margin-bottom: 12px;
            }
          
            /* 6. Styling for all jsPsych buttons */
            .jspsych-btn {
              margin-top: 20px;
              font-size: 18px;
              padding: 10px 20px;
            }
          
            /* 7. Center single-line buttons (e.g., Continue) */
            .jspsych-html-button-response-button {
              margin: 10px auto;
            }
          </style>  
    </head>

    <script>
        // Initialize jsPsych with WebGazer extension and set end behavior
        const jsPsych = initJsPsych({
            extensions: [{ type: jsPsychExtensionWebgazer }],
            on_finish: () => jatos.endStudy(jsPsych.data.get().json())
        });

        // Global variables
        let pixelsPerDegree = 50;                // Default value, updated by virtual chinrest
        const imageHeight = 26 * pixelsPerDegree; // Determines image display size (in visual angle)
        let calibrationCountThisBlock = 0;       // Tracks calibration attempts per block
        let baselineZoom = 1.0;                  // Stores browser zoom level for later comparison

        // Utility to detect browser zoom level
        function detectZoomLevel() {
            return window.devicePixelRatio || 1;
        }

        // Virtual chinrest trial — calibrates pixels-per-degree based on blindspot
        const virtual_chinrest = {
            type: jsPsychVirtualChinrest,
            blindspot_reps: 3,
            resize_units: "deg",
            pixels_per_unit: 50,
            item_path: 'stimuli/credit_card.png',
            on_finish: function(data) {
                const maxPPD = window.innerHeight / 26;
                if (data.pixels_per_degree) {
                const wasClamped = data.pixels_per_degree > maxPPD;
                data.original_pixels_per_degree = data.pixels_per_degree;
                data.pixels_per_degree = Math.min(data.pixels_per_degree, maxPPD);
                data.was_clamped = wasClamped;
                data.baseline_zoom = detectZoomLevel();
                pixelsPerDegree = data.pixels_per_degree;
                } else {
                data.original_pixels_per_degree = 50;
                data.pixels_per_degree = 50;
                data.was_clamped = false;
                data.baseline_zoom = detectZoomLevel();
                pixelsPerDegree = 50;
                }
            }
        };

        // Dummy trial to add chinrest-calculated pixelsPerDegree to the global state
        const get_pixels_per_degree = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<p>Calibrating image size...</p>",
            choices: "NO_KEYS",
            trial_duration: 100,
            on_start: function() {
                const chinrestData = jsPsych.data.get().filter({ trial_type: 'virtual-chinrest' }).last(1).values()[0];
                if (chinrestData && chinrestData.pixels_per_degree) {
                const proposedPPD = chinrestData.pixels_per_degree;
                const maxPPD = window.innerHeight / 26;
                pixelsPerDegree = Math.min(proposedPPD, maxPPD);

                const wasClamped = proposedPPD > maxPPD;

                jsPsych.data.addProperties({
                    pixels_per_degree: pixelsPerDegree,
                    original_pixels_per_degree: proposedPPD,
                    was_clamped: wasClamped,
                    baseline_zoom: detectZoomLevel()
                });
                } else {
                console.warn("⚠️ No chinrest data found. Using fallback.");
                pixelsPerDegree = 50;
                jsPsych.data.addProperties({
                    pixels_per_degree: 50,
                    was_clamped: false,
                    original_pixels_per_degree: 50,
                    baseline_zoom: detectZoomLevel()
                });
                }
            }
        };

        // Warn participant if chinrest suggested their screen was too small
        const distance_warning_screen = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                const chinrestData = jsPsych.data.get().filter({ trial_type: 'virtual-chinrest' }).last(1).values()[0];
                if (chinrestData && chinrestData.was_clamped) {
                return `
                    <p style="font-size: 24px; color: red;">⚠️ You appear to be sitting too far from the screen.</p>
                    <p style="font-size: 20px;">To ensure the image fits on screen, please move closer and recalibrate.</p>
                    <p style="font-size: 20px;">Press <b>Recalibrate</b> to redo the calibration process.</p>
                `;
                } else {
                return `<p style="font-size: 22px;">Calibration complete. Press Continue to proceed.</p>`;
                }
            },
            choices: function() {
                const chinrestData = jsPsych.data.get().filter({ trial_type: 'virtual-chinrest' }).last(1).values()[0];
                return chinrestData && chinrestData.was_clamped ? ['Recalibrate'] : ['Continue'];
            }
        };

        // Loop chinrest calibration until participant is at proper distance
        const distance_check_loop = {
            timeline: [
                virtual_chinrest,
                {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: "<p>Calibrating image size...</p>",
                choices: "NO_KEYS",
                trial_duration: 100,
                },
                distance_warning_screen
            ],
            loop_function: function() {
                const chinrestData = jsPsych.data.get().filter({ trial_type: 'virtual-chinrest' }).last(1).values()[0];
                return chinrestData && chinrestData.was_clamped;
            }
        };

        // Store browser zoom level (for logging or quality control)
        const store_zoom_level = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<p>Checking browser zoom level...</p>",
            choices: "NO_KEYS",
            trial_duration: 100,
            on_start: function() {
                baselineZoom = detectZoomLevel();
                console.log("✅ Baseline Zoom Level:", baselineZoom);
            }
        };

        // Show consent form before the experiment starts
        const consent_form = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div style="max-width: 800px; margin: 0 auto; text-align: left; font-size: 20px;">
            <h2 style="text-align: center;">Study consent form</h2>

            <p>The School of Psychological Sciences at Tel-Aviv University would like to thank you for participating in an important scientific study in the group-breaking field of cognitive psychology.</p>

            <p>The results collected from your response will greatly contribute to scientific progress and human development.</p>

            <p>Tel-Aviv University supports the protection of participants in research. The following will provide you with information about the experiment that will help you in deciding whether or not you wish to participate.</p>

            <p>If you agree to participate, please be aware that you are free to withdraw at any point throughout the duration of the experiment.</p>

            <p>In this study you will be asked to watch a video clip while trying to notice and report an unexpected change and answering questions about details of the clip.</p>

            <p>All information you provide will remain confidential and will not be associated with your name.</p>

            <p>Your participation in this study will take approximately 10 minutes.</p>

            <p>If you have any further questions concerning this study please feel free to contact us through email: Liad Mudrik mudriklab2@gmail.com.</p>

            <p>Your participation is solicited, yet strictly voluntary.</p>

            <p>Please indicate below that you understand your rights and agree to participate in the experiment or exit the experiment if you do not wish to participate.</p>
            </div>
        `,
        choices: ['Consent']
        };



        // Preload masks and fixation_cross
        const preload_masks = {
            type: jsPsychPreload,
            images: Array.from({length: 30}, (_, i) =>
                `stimuli/masks/mask_${String(i + 1).padStart(2, '0')}.jpg`
            ).concat('stimuli/fixation_cross.png') // ✅ Add fixation cross here
        };

     
        // Get participant info
        var participant_info_questions = {
            type: jsPsychSurveyHtmlForm,
            html: `
                <p><label>Prolific ID: <input name="ProlificID" required></label></p>
                <p><label>Age: <input name="age" type="number" required></label></p>
                <p><label>Gender:
                    <select name="gender" required>
                        <option value="" disabled selected>Select gender</option>
                        <option value="Female">Female</option>
                        <option value="Male">Male</option>
                        <option value="Other">Other</option>
                        <option value="Prefer not to answer">Prefer not to answer</option>
                    </select>
                </label></p>
                <p><label>Handedness:
                    <select name="handedness" required>
                        <option value="" disabled selected>Select handedness</option>
                        <option value="Left">Left</option>
                        <option value="Right">Right</option>
                    </select>
                </label></p>
            `,
            button_label: "Submit"
        };


        // Instructions and metadata collection
        var instructions = {
        type : jsPsychInstructions,
        pages : [
            '<p style ="font-size=24px">Welcome to our experiment!</p>' +
            '<p style ="font-size=26px">Press "Next" to read its instructions</p>',
            '<p style ="font-size=26px">In this experiment, you will see pairs of images presented one after the other.</p>' +
            '<p style ="font-size=26px">Your task is to rate how similar the two images are on a scale from "Very Different" to "Very Similar".</p>',
            '<p style ="font-size=26px">Please make sure to pay close attention to the images as they appear on the screen.</p>',
            '<p style ="font-size=26px">After viewing both images in a pair, use the slider to provide your similarity rating.</p>' + 
            '<p style ="font-size=26px">Press "Next" when you are ready to begin the experiment.</p>'
        ],
        show_clickable_nav : true
        };

        
        // Move to full screen mode
        var show_full_screen = {
            type: jsPsychFullscreen,
            message: '<p>The experiment will switch to full screen mode when you press the button below</p>' +
            '<p>Do not exit full screen mode until the end of the experiment</p>',
            fullscreen_mode: true
        };

        // Instructions before webgazer calibration
        var camera_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <p>In order to participate you must allow the experiment to use your camera.</p>
          <p>You will be prompted to do this on the next screen.</p>
          <p>If you do not wish to allow use of your camera, you cannot participate in this experiment.<p>
          <p>It may take up to 30 seconds for the camera to initialize after you give permission.</p>
        `,
        choices: ['Got it'],
        }

        // Camera intiation documentation: https://www.jspsych.org/latest/plugins/webgazer-init-camera/
        var init_camera = {
            type: jsPsychWebgazerInitCamera
        }

        // Instruction before calibration
        var calibration_instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
            <p>Now you'll calibrate the eye tracking, so that the software can use the image of your eyes to predict where you are looking.</p>
            <p>You'll see a series of dots appear on the screen. Look at each dot and click on it.</p>
            `,
            choices: ['Got it'],
        }


        // Clibration documenting: https://www.jspsych.org/latest/plugins/webgazer-calibrate/
        var calibration = {
            type: jsPsychWebgazerCalibrate,
            // Numbers calibrated are percent of pixels from [left,top]
            on_start: function() {
                calibrationCountThisBlock++;
            },
            calibration_points: [
            [25,25],[75,25],[50,50],[25,75],[75,75]
            ],
            repetitions_per_point: 2,
            randomize_calibration_order: true
        }

        var validation_instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
            <p>Now we'll measure the accuracy of the calibration.</p>
            <p>Look at each dot as it appears on the screen.</p>
            <p style="font-weight: bold;">You do not need to click on the dots this time.</p>
            `,
            choices: ['Got it'],
            post_trial_gap: 1000
        }

        // Validation documentation: https://www.jspsych.org/latest/plugins/webgazer-validate/
        var validation = {
            type: jsPsychWebgazerValidate,
            validation_points: [
            [25,25],[75,25],[50,50],[25,75],[75,75]
            ],
            roi_radius: 200,
            time_to_saccade: 1000,
            validation_duration: 2000,
            data: {
            task: 'validate'
            }
        }

        // If calibration is not accurate enough, instruct to recalibrate
        var recalibrate_instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
            <p>The accuracy of the calibration is a little lower than we'd like.</p>
            <p>Let's try calibrating one more time.</p>
            <p>On the next screen, look at the dots and click on them.<p>
            `,
            choices: ['OK'],
        }

        // Calibration is suffiecient - can move on to validation
        var calibration_done = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
            <p>Great, we're done with calibration!</p>
            `,
            choices: ['OK']
        }

        // Calibration was validated sufficiently- can move on to experiment
        var validation_done = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <p>✅ Calibration complete!</p>
                <p>Your eye tracking accuracy is sufficient.</p>
                <p>Click the button below to continue to the experiment.</p>
            `,
            choices: ['Continue']
        };

        // Ready to move on to practice trial
        const post_calibration_instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <p style="font-size: 22px;">Now, you'll complete a short <b>practice trial</b> to get used to the task.</p>
                <p style="font-size: 22px;">Please pay close attention and respond as you would in the real task.</p> 
                <p style="font-size: 22px;"><b>Click Continue to begin the practice trial.</b></p>
            `,
            choices: ['Continue']
        };


        
        // Loop that runs until validation is sufficient
        var calibration_loop = {
            timeline: [
                // conditional recalibration instructions - only from the 2nd loop
                {
                    timeline: [recalibrate_instructions],
                    conditional_function: function() {
                        // Only show recalibrate_instructions if this is NOT the first calibration
                        return calibrationCountThisBlock > 0;  
                    }
                },
                calibration,                    // shows dot-click calibration
                calibration_done,              // "We're done" screen
                validation_instructions,       // tells them not to click
                validation,                   // gaze-only validation
            ],
            loop_function: function() {
                // ⛳ This function runs after each full cycle of the above timeline
                const valData = jsPsych.data.get().filter({ task: 'validate' }).last(1).values()[0];
                
                // ✅ Repeat the loop if ANY point is under 50% accuracy
                return valData && valData.percent_in_roi
                    ? valData.percent_in_roi.some(p => p < 10)
                    : true; // just in case data is missing
            }
        };


        // Recalibration instruction between each block
        const pre_calibration_message = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <p style="font-size: 26px;">Before the next block begins, we need to recalibrate the eye tracker.</p>
                <p style="font-size: 22px;">This helps ensure your gaze data is accurate.</p>
                <p style="font-size: 22px;">Please follow the instructions on the next screens and look directly at the dots.</p>
            `,
            choices: ['Continue']
        };



        // Recheck zoom level before block
        var check_zoom_loop = {
            timeline: [
                {
                    type: jsPsychHtmlButtonResponse,
                    stimulus: function() {
                        const currentZoom = detectZoomLevel();
                        const deviation = Math.abs(currentZoom - baselineZoom);
                        const currentPercent = Math.round(currentZoom * 100);
                        const baselinePercent = Math.round(baselineZoom * 100);

                        // check if zoom is still ok
                        if (deviation > 0.05) {
                            console.warn("⚠️ Zoom changed! Current:", currentZoom, "Baseline:", baselineZoom);
                            return `
                                <p style="color:red; font-size:24px;">
                                    ⚠️ Your browser zoom level has changed since the calibration.<br><br>
                                    Please adjust your zoom (Ctrl + or - / Cmd + or -) to match the calibrated value.
                                </p>
                                <p style="font-size:20px;">
                                    Expected zoom: <b>${baselinePercent}%</b><br>
                                    Current zoom: <b>${currentPercent}%</b>
                                </p>
                                <p style="font-size:18px; color:#666;">
                                    Click the button once you've adjusted your zoom to match.
                                </p>`;
                        } else {
                            console.log("✅ Zoom OK:", currentZoom);
                            return `<p style="font-size:24px;">Zoom level OK (${currentPercent}%). Continuing the experiment...</p>`;
                        }
                    },
                    choices: ['I’ve adjusted my zoom — continue'],
                }
            ],
            loop_function: function() {
                const currentZoom = detectZoomLevel();
                const deviation = Math.abs(currentZoom - baselineZoom);
                return deviation > 0.05; // keep looping until matched
            }
        };


        // Core fixation trial — monitors gaze for 500ms inside 1-degree ROI
        const smartFixationCore = {
            type: jsPsychImageKeyboardResponse,
            stimulus: 'stimuli/fixation_cross.png',
            stimulus_height: imageHeight,
            data: { trial_id: 'fixation' },
            choices: "NO_KEYS",
            trial_duration: null, // we manually end the trial

            on_load: function() {
                const buffer = [];
                const radiusPx = pixelsPerDegree * 10; // for practice - 10 degrees real - 1 degree radius
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const startTime = performance.now();

                // Expose buffer so on_finish can access it
                jsPsych.pluginAPI.getCurrentTrialGazeBuffer = () => buffer;

                const interval = setInterval(async () => {
                const now = performance.now();
                const gaze = await webgazer.getCurrentPrediction();

                if (gaze && gaze.x != null && gaze.y != null) {
                    const dx = gaze.x - centerX;
                    const dy = gaze.y - centerY;
                    const inside = Math.sqrt(dx * dx + dy * dy) <= radiusPx;

                    buffer.push({ x: gaze.x, y: gaze.y, t: now, inside });

                    // Keep last 500ms of gaze
                    const recent = buffer.filter(pt => now - pt.t <= 500);
                    const recentInside = recent.filter(pt => pt.inside);
                    const percent = (recentInside.length / recent.length) * 100;

                    console.log(`📊 Gaze buffer: ${percent.toFixed(1)}% in ROI`);

                    if (recent.length >= 6 && percent >= 50) {
                    clearInterval(interval);
                    jsPsych.finishTrial({ fixation_success: true });
                    }
                }

                if (now - startTime > 10000) {
                    clearInterval(interval);
                    console.warn("⏱ Fixation failed: 10s timeout");
                    jsPsych.finishTrial(); // fallback → on_finish sets success = false
                }
                }, 50);
            },

            on_finish: function(data) {
                const buffer = jsPsych.pluginAPI.getCurrentTrialGazeBuffer?.() || [];

                if (typeof data.fixation_success === 'undefined') {
                data.fixation_success = false;
                }

                // Optional: log more about the gaze behavior
                data.fixation_samples_total = buffer.length;
                data.fixation_samples_on_target = buffer.filter(pt => pt.inside).length;
                data.fixation_percent_on_target = buffer.length > 0
                ? (data.fixation_samples_on_target / buffer.length) * 100
                : 0;

                console.log("✅ Fixation trial ended. Success:", data.fixation_success);
            }
            };


        // Retry screen shown if fixation fails (gaze not centered within 10s)
        const smartFixationRetry = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <p style="font-size: 24px;">Please center your gaze on the cross.</p>
                <p id="countdown-text" style="font-size: 18px;">Returning in 10 seconds...</p>`,
            choices: "NO_KEYS",
            trial_duration: 10000,
            on_load: function() {
                let seconds = 10;
                const txt = document.getElementById("countdown-text");
                const interval = setInterval(() => {
                seconds--;
                if (txt) txt.innerText = `Returning in ${seconds} seconds...`;
                if (seconds <= 0) clearInterval(interval);
                }, 1000);
            }
        };

        // ✅ Function that returns a full fixation validation loop
        // Includes:
        // - smartFixationCore (monitors gaze for 500ms)
        // - Retry screen if validation fails
        // Repeats until fixation is valid    
        function getSmartFixationTrial() {
            return {
                timeline: [
                smartFixationCore,  // actual gaze buffer logic
                {
                    timeline: [smartFixationRetry],
                    conditional_function: function() {
                        const last = jsPsych.data.get().filter({ trial_id: 'fixation' }).last(1).values()[0];
                        console.log("🧪 Retry condition check — fixation_success:", last?.fixation_success);
                    return last && last.fixation_success === false;
                    }
                }
                ],
                loop_function: function() {
                    const last = jsPsych.data.get().filter({ trial_id: 'fixation' }).last(1).values()[0];
                    console.log("🔁 Loop check — fixation_success:", last?.fixation_success);
                    return last && last.fixation_success === false;
                }
            };
        }


        // Defines the full structure of a similarity trial
        // Includes:
        //  - Fixation (with gaze validation)
        //  - Image 1
        //  - Mask 1
        //  - Fixation 2 (optional gaze check)
        //  - Image 2
        //  - Mask 2
        //  - Similarity rating (1–5)
        var sequential_trial = {
            timeline: [
                // 1. Smart fixation with gaze buffer logic
                    getSmartFixationTrial(pixelsPerDegree, 40),

                // Image 1
                {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: function () {
                        const img = jsPsych.timelineVariable('image1');
                        return `
                        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
                            <img src="${img}" style="height: ${26 * pixelsPerDegree}px; max-height: 100vh; display: block;" />
                        </div>`;
                    },
                    choices: "NO_KEYS",
                    trial_duration: 1000,
                    extensions: [{
                        type: jsPsychExtensionWebgazer,
                        params: {
                            targets: ['img']
                        }
                    }]
                },

                // Mask after image 1
                {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: function () {
                        const idx = Math.floor(Math.random() * 30) + 1;
                        const maskPath = `stimuli/masks/mask_${String(idx).padStart(2, '0')}.jpg`;
                        return `
                        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
                            <img src="${maskPath}" style="height: ${26 * pixelsPerDegree}px; max-height: 100vh; display: block;" />
                        </div>`;
                    },
                    choices: "NO_KEYS",
                    trial_duration: 500,
                    extensions: [{
                        type: jsPsychExtensionWebgazer,
                        params: {
                            targets: ['img']
                        }
                    }]
                },

                // Fixation before image 2
                {
                    type: jsPsychImageKeyboardResponse,
                    stimulus: 'stimuli/fixation_cross.png',
                    stimulus_height: imageHeight,
                    choices: "NO_KEYS",
                    trial_duration: 500,
                    extensions: [{
                        type: jsPsychExtensionWebgazer,
                        params: {
                            targets: ['#jspsych-image-keyboard-response-stimulus']
                        }
                    }]
                },

                // Image 2
                {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: function () {
                        const img = jsPsych.timelineVariable('image2');
                        return `
                        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
                            <img src="${img}" style="height: ${26 * pixelsPerDegree}px; max-height: 100vh; display: block;" />
                        </div>`;
                    },
                    choices: "NO_KEYS",
                    trial_duration: 1000,
                    extensions: [{
                        type: jsPsychExtensionWebgazer,
                        params: {
                            targets: ['img']
                        }
                    }]
                },

                // Mask after Image 2
                {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: function () {
                        const idx = Math.floor(Math.random() * 30) + 1;
                        const maskPath = `stimuli/masks/mask_${String(idx).padStart(2, '0')}.jpg`;
                        return `
                        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
                            <img src="${maskPath}" style="height: ${26 * pixelsPerDegree}px; max-height: 100vh; display: block;" />
                        </div>`;
                    },
                    choices: "NO_KEYS",
                    trial_duration: 500,
                    extensions: [{
                        type: jsPsychExtensionWebgazer,
                        params: {
                            targets: ['img']
                        }
                    }]
                },

                // Similarity rating
                {
                    type: jsPsychSurveyMultiChoice,
                    questions: [
                        {
                            prompt: "",
                            name: "similarity",
                            options: ["1", "2", "3", "4", "5"],
                            required: true,
                            horizontal: true
                        }
                    ],
                    on_load: function () {
                        const container = document.querySelector('.jspsych-content');

                        // Add top prompt
                        const promptText = document.createElement('div');
                        promptText.innerHTML = `
                        <p style="font-size: 20px; text-align: center;">
                            Please rate the similarity of the two images using the following scale:<br>
                        </p>`;
                        container.insertBefore(promptText, container.firstChild);

                        // Style the question block horizontally
                        const questionWrapper = document.querySelector('.jspsych-survey-multi-choice-question');
                        questionWrapper.style.display = 'flex';
                        questionWrapper.style.justifyContent = 'center';
                        questionWrapper.style.alignItems = 'center';
                        questionWrapper.style.gap = '12px';
                        questionWrapper.style.margin = '10px 0';

                        // Create side labels
                        const leftLabel = document.createElement('div');
                        const rightLabel = document.createElement('div');
                        leftLabel.innerText = "Not at all similar";
                        rightLabel.innerText = "Extremely similar";
                        [leftLabel, rightLabel].forEach(label => {
                            label.style.fontSize = '14px';
                            label.style.width = '120px';
                        });

                        // Insert side labels
                        questionWrapper.prepend(leftLabel);
                        questionWrapper.appendChild(rightLabel);

                        // Style each option (number above button)
                        const options = questionWrapper.querySelectorAll('.jspsych-survey-multi-choice-option');
                        options.forEach(option => {
                            const label = option.querySelector('label');
                            const input = option.querySelector('input[type="radio"]');
                            option.innerHTML = '';

                            option.style.display = 'flex';
                            option.style.flexDirection = 'column';
                            option.style.alignItems = 'center';
                            option.style.margin = '0 5px';

                            label.style.marginBottom = '4px';
                            option.appendChild(label);
                            option.appendChild(input);
                        });

                        // Hide red asterisk if exists
                        const requiredMark = document.querySelector('.jspsych-survey-multi-choice-required');
                        if (requiredMark) {
                            requiredMark.style.display = 'none';
                        }
                    }
                }
            ],
            timeline_variables: [], // fill in your image1/image2 combinations here
            randomize_order: true
        };


        // Instructions before the practice trial
        // Explains the goal and structure of the practice round
        const practice_instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <p style="font-size: 24px;">You're about to begin a practice trial.</p>
                <p style="font-size: 22px;">In each trial, you'll see two images presented one after the other.</p>
                <p style="font-size: 22px;">Your task is to rate how similar the images are using a 1–5 scale.</p>
                <p style="font-size: 22px;">This is just a practice round to help you get used to the task.</p>
                <p style="font-size: 22px;"><b>Click Continue when you're ready.</b></p>
            `,
            choices: ['Continue']
        };

        // Preload images used in the practice trial
        // Ensures the two image files are loaded before they're shown
        const preload_practice_images = {
            type: jsPsychPreload,
            images: [
                'stimuli/pictures/image_001.jpg',
                'stimuli/pictures/image_002.jpg'
            ]
        };

        // Define the image pair used in the practice trial
        // Same format as the main experiment blocks
        const practice_timeline_variables = [
            {
                image1: 'stimuli/pictures/image_001.jpg',
                image2: 'stimuli/pictures/image_002.jpg'
            }
            ];

        // Run a single practice trial using the full similarity structure
        // Reuses the same trial structure from the main experiment
        const practice_block = {
            timeline: sequential_trial.timeline,
            timeline_variables: practice_timeline_variables
        };


        // More in depth instructions for the experiment
        const before_exp_screen = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p style="font-size:30px;">We are ready to start the experiment!</p>
            <p style="font-size:23px;">In this experiment, you will view pairs of images presented one after the other.</p>
            <p style="font-size:23px;">Your task is to evaluate the similarity between the two images and provide a rating on a slider.</p>
            <p style="font-size:23px;">Pay close attention to each image and try to focus on the details before making your decision.</p>
            <p style="font-size:23px;">Press <b>"Start"</b> to begin the experiment.</p>`,
        choices: ['Start']
        };


        // ====== Resets calibration counter to 0 ======
        const reset_calibration_counter = {
            type: jsPsychCallFunction,
            func: function() {
                calibrationCountThisBlock = 0;
            }
        };


        // ====== Generate image pairs and set the pairs in a random order ======
        const ordered_pairs = [];
        for (let i = 1; i <= 400; i += 2) {
            const image1 = `stimuli/pictures/image_${String(i).padStart(3, '0')}.jpg`;
            const image2 = `stimuli/pictures/image_${String(i + 1).padStart(3, '0')}.jpg`;
            ordered_pairs.push({ image1, image2 });
        }
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        shuffle(ordered_pairs);



        // ====== Divide into 4 ordered blocks of 50 trials ======
        const blocks = [];
        const trialsPerBlock = 3; // how many trials in each block - should be 50 (1 for testing)
        
        for (let i = 0; i < 4; i++) {
            const block_pairs = ordered_pairs.slice(i * trialsPerBlock, (i + 1) * trialsPerBlock);
            const block_images = block_pairs.flatMap(pair => [pair.image1, pair.image2]);

            const preload_block_images = {
                type: jsPsychPreload,
                images: block_images
            };

            const block = {
                timeline: [
                    preload_block_images,  // ✅ Load only images for this block
                    check_zoom_loop,
                    {
                        timeline: sequential_trial.timeline,
                        timeline_variables: block_pairs,
                        data: { block_number: i + 1 },
                        on_start: function() {
                            calibrationCountThisBlock = 0;
                            const zoomPercent = Math.round(detectZoomLevel() * 100);
                            jsPsych.data.addProperties({
                                [`zoom_at_block_${i + 1}_percent`]: zoomPercent,
                            });
                        },
                        on_finish: function() {
                            jsPsych.data.addProperties({
                                [`calibration_count_at_block_${i + 1}`]: calibrationCountThisBlock
                            }); 
                        }
                    },
                    ...(i < 3 ? [
                        {
                        type: jsPsychHtmlButtonResponse,
                        stimulus: `<p style="font-size:24px;">Block ${i + 1} complete.<br>
                                    Please rest. When you are ready, click <b>Continue</b>.</p>`,
                        choices: ['Continue']
                        }
                    ] : [])
                ]
            };

            blocks.push(block);
        }



        ////////////////////////
        // Experiment ending  // 
        ////////////////////////

        // before ending the experiment, exit full screen mode
        var exit_full_screen = {
            type: jsPsychFullscreen,
            fullscreen_mode: false,
            delay_after: 5
        };
        
        // the ending screen of the experiment
        var finish_exp = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<p style="font-size=42px">Thank you for participating!</p>' +
            '<p style="font-size=47x"><b>Don\'t close the window yet!</b></p>' +
            '<p style="font-size=42px">Press any key to finish the experiment</p>'
        };
        
    

        ////////////////////////
        // Experiment Timeline / 
        ////////////////////////
        const timeline_start = [
            
            // Virtual chinrest: distance estimation & zoom validation
            distance_check_loop,

            // Consent + participant info
            consent_form,
            preload_masks,
            participant_info_questions,

            // Instructions before eye tracking begins
            instructions,
            show_full_screen,
            
            
            // Camera and WebGazer setup
            camera_instructions,
            init_camera,

            // Calibration loop (with validation and optional retry instructions)
            calibration_loop,

            // Calibration was validated successfuly, thus finishing the calibration loop
            validation_done,
            post_calibration_instructions, 
            
            // Practice trial
            practice_instructions,
            preload_practice_images,
            practice_block,

            // Transition screen before starting the main experiment
            before_exp_screen,

            // 1st Block
            blocks[0],

            // Recalibration after 1st block
            pre_calibration_message,
            reset_calibration_counter,
            calibration_loop,
            validation_done,

            // 2nd Block
            blocks[1],

            pre_calibration_message,
            reset_calibration_counter,
            calibration_loop,
            validation_done,

            // 3rd Block            
            blocks[2],

            pre_calibration_message,
            reset_calibration_counter,
            calibration_loop,
            validation_done,

            // 4th Block            
            blocks[3],

            // Exit fullscreen and debrief/thank-you screen
            exit_full_screen,
            finish_exp
        ];


        jatos.onLoad(() => {
            console.log("Experiment is starting");
            jsPsych.run(timeline_start);
        });

    </script>

</html>